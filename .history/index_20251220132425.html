<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Germany PLZ Map</title>

    <!-- 1. Load Map Libraries from CDN -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/pmtiles@2.11.0/dist/index.js"></script>

    <!-- Link to external CSS -->
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- Left Side: Text Content -->
    <div id="sidebar">
        <h1>TEST MAP</h1>
        <p>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et
            dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex
            ea commodo consequat.
        </p>
        <p>
            Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
            Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est
            laborum.
        </p>
        <p>
            Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem
            aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.
        </p>
    </div>

    <!-- Right Side: Interactive Map -->
    <div id="map-container">
        <div id="map"></div>

        <!-- UI Controls -->
        <div class="controls">
            <h3>Regional Sales</h3>
            <label for="filter-select">Filter by Revenue:</label>
            <select id="filter-select">
                <option value="all">Show All Regions</option>
                <option value="high">High Revenue (> 600)</option>
                <option value="low">Low Revenue (< 200)</option>
                <option value="missing">No Data Available</option>
            </select>
        </div>

        <div class="legend" id="legend">
            <strong>Sales Volume</strong>
            <!-- JS will populate this -->
        </div>
    </div>

    <script>
        // --- SETTINGS ---
        // Ensure these file names match exactly what you upload to GitHub
        const PMTILES_URL = "germany_plz.pmtiles";
        const DATA_URL = "sales_data.json";

        // --- COLORS ---
        const colors = [
            { max: 200, color: '#fee5d9', label: 'Low (< 200)' },
            { max: 600, color: '#fcae91', label: 'Medium (200-600)' },
            { max: 900, color: '#fb6a4a', label: 'High (600-900)' },
            { max: Infinity, color: '#cb181d', label: 'Very High (> 900)' }
        ];
        const defaultColor = '#eeeeee';

        let globalData = {}; // Stores the loaded JSON data

        // --- MAP INIT ---
        const protocol = new pmtiles.Protocol();
        maplibregl.addProtocol("pmtiles", protocol.tile);

        const map = new maplibregl.Map({
            container: 'map',
            // Carto Positron: A clean, grey basemap perfect for data overlays
            style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
            // Bounding box for Germany to ensure it fits the screen
            bounds: [[5.866, 47.270], [15.042, 55.058]],
            fitBoundsOptions: { padding: 50 }
        });

        // --- LOAD LOGIC ---
        map.on('load', async () => {
            try {
                // 1. Load external sales data
                const response = await fetch(DATA_URL);
                globalData = await response.json();

                // 2. Add Map Source
                map.addSource("plz_source", {
                    type: "vector",
                    url: `pmtiles://${PMTILES_URL}`
                });

                // 3. Build Color Logic (Match Expression)
                const matchExpr = ['match', ['get', 'plz']]; // 'plz' is the column name in PMTiles
                for (const [plz, val] of Object.entries(globalData)) {
                    const c = colors.find(x => val <= x.max);
                    if (c) { matchExpr.push(plz); matchExpr.push(c.color); }
                }
                matchExpr.push(defaultColor); // Fallback color

                // 4. Add Fill Layer
                map.addLayer({
                    "id": "plz-fills",
                    "type": "fill",
                    "source": "plz_source",
                    "source-layer": "plz_areas", // Must match Tippecanoe layer name
                    "paint": {
                        "fill-color": matchExpr,
                        "fill-opacity": 0.8
                    }
                });

                // 5. Add Border Layer
                map.addLayer({
                    "id": "plz-borders",
                    "type": "line",
                    "source": "plz_source",
                    "source-layer": "plz_areas",
                    "paint": {
                        "line-color": "#888",
                        "line-width": 0.5
                    }
                });

            } catch (error) {
                console.error("Error loading data:", error);
                alert("Could not load map data. Ensure 'germany_plz.pmtiles' and 'sales_data.json' are in the same folder.");
            }
        });

        // --- INTERACTION: POPUPS ---
        const popup = new maplibregl.Popup({ closeButton: false, closeOnClick: false });

        map.on('mousemove', 'plz-fills', (e) => {
            map.getCanvas().style.cursor = 'pointer';
            const feature = e.features[0];
            const plzId = feature.properties['plz'];
            const val = globalData[plzId];

            let html = `<div style="font-size:13px"><strong>PLZ: ${plzId}</strong>`;
            html += val !== undefined ? `<br>Sales: ${val}` : `<br><em style="color:#999">No Data</em></div>`;

            popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
        });

        map.on('mouseleave', 'plz-fills', () => {
            map.getCanvas().style.cursor = '';
            popup.remove();
        });

        // --- INTERACTION: FILTER ---
        document.getElementById('filter-select').addEventListener('change', (e) => {
            const cat = e.target.value;
            let filterExpr = null; // Null means "show everything"

            if (cat === 'high') {
                const ids = Object.keys(globalData).filter(id => globalData[id] > 600);
                filterExpr = ['in', ['get', 'plz'], ['literal', ids]];
            } else if (cat === 'low') {
                const ids = Object.keys(globalData).filter(id => globalData[id] < 200);
                filterExpr = ['in', ['get', 'plz'], ['literal', ids]];
            } else if (cat === 'missing') {
                const ids = Object.keys(globalData);
                filterExpr = ['!', ['in', ['get', 'plz'], ['literal', ids]]];
            }

            if (map.getLayer('plz-fills')) {
                map.setFilter('plz-fills', filterExpr);
                map.setFilter('plz-borders', filterExpr);
            }
        });

        // --- BUILD LEGEND HTML ---
        const legendEl = document.getElementById('legend');
        colors.forEach(c => {
            legendEl.innerHTML += `
            <div class="legend-item">
                <div class="color-box" style="background:${c.color}"></div> ${c.label}
            </div>`;
        });
        legendEl.innerHTML += `<div class="legend-item"><div class="color-box" style="background:${defaultColor}"></div> No Data</div>`;

    </script>
</body>

</html>